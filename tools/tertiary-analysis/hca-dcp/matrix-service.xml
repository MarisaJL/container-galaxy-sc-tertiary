<?xml version="1.0" encoding="utf-8"?>
<tool id="dcp-matrix-service-retrieve" name="DCP Matrix Service Data Retrieval" version="v0.0.1+galaxy0">
  <description>Retrieves expression matrices and metadata.</description>
  <requirements>
    <requirement type="package" version="2.22.0">requests</requirement>
  </requirements>
  <command detect_errors="exit_code"><![CDATA[

client.py -p '${project_uuid}' -f '${matrix_format}'

#if str($matrix_format) == "loom":

#else if str($matrix_format) == "csv":

#else if str($matrix_format) == "mtx":

#end if

    'https://www.ebi.ac.uk/gxa/sc/experiment/${accession}/download?fileType=experiment-design&accessKey=';

]]></command>

  <inputs>
    <param name="project_uuid" type="text" value="cddab57b-6868-4be4-806f-395ed9dd635a" label="Human Cell Atlas Project UUID" help="HCA Project UUID, normally available in the project URL, such as https://prod.data.humancellatlas.org/explore/projects/cddab57b-6868-4be4-806f-395ed9dd635a (the part after 'projects')."/>
    <param name="matrix_format" type="select" label="Choose the matrix format to download" help="Format for the matrix can be tsv, Loom or matrix market">
      <option value="loom" selected="true">Loom matrix format, includes metadata</option>
      <option value="csv">CSV format</option>
      <option value="mtx">Matrix market matrix format</option>
    </param>
  </inputs>

  <outputs>
    <data name="matrix_mtx" format="txt" label="${tool.name} on ${on_string} ${accession} matrix.mtx (${matrix_type.value_label})"/>
    <data name="genes_tsv" format="tsv" label="${tool.name} on ${on_string} ${accession} genes.tsv (${matrix_type.value_label})"/>
    <data name="barcode_tsv" format="tsv" label="${tool.name} on ${on_string} ${accession} barcodes.tsv (${matrix_type.value_label})"/>
    <data name="design_tsv" format="tsv" from_work_dir="exp_design.tsv" label="${tool.name} on ${on_string} ${accession} exp_design.tsv"/>
  </outputs>

  <tests>
    <test>
      <param name="accession" value="E-GEOD-100058"/>
      <param name="matrix_type" value="tpm"/>
      <output name="matrix_mtx" file="E-GEOD-100058.expression_tpm.mtx" ftype="txt"/>
      <output name="genes_tsv" file="E-GEOD-100058.genes.tsv" ftype="tsv"/>
      <output name="barcode_tsv" file="E-GEOD-100058.barcodes.tsv" ftype="tsv"/>
      <output name="design_tsv" file="E-GEOD-100058.exp_design.tsv" ftype="tsv"/>
    </test>
  </tests>

  <help><![CDATA[
=================================================================================
Gene expression analysis in single cells across species and biological conditions
=================================================================================

Single Cell Expression Atlas supports research in single cell transcriptomics.
The Atlas annotates publicly available single cell RNA-Seq experiments with
ontology identifiers and re-analyses them using standardised pipelines available
through iRAP, our RNA-Seq analysis toolkit. The browser enables visualisation of
clusters of cells, their annotations and supports searches for gene expression
within and across studies.

For more information check https://www.ebi.ac.uk/gxa/sc/home

EBI SCXA Data Retrieval
-----------------------

The data retrieval tool presented here allows the user to retrieve expression matrices
and metadata for any public experiment available at EBI Single Cell Expression Atlas.

To use it, simply set the accession for the desired experiment and choose the type of
matrix that you want to download:

:Raw filtered counts:
  This should be the default choice for running clustering and another analysis
  methods where you will introduce scaling and normalization of the data. The filtering
  is based on the quality control applied by iRAP prior to pseudo-alignment and quantification.

:TPMs:
  TPM stands for Transcripts Per Kilobase Million, and as the name implies, this has been
  already normalized/scaled. You should keep this in mind when using this data
  on methods that will try to normalise data as part of their procedure. Due to technical
  particularities in the current Atlas SC pipeline, TPMs available here are not filtered.

Outputs will be:

:Matrix (txt):
  Contains the expression values for genes (rows) and samples/runs/cells (columns),
  in either raw filtered counts or filtered tpms depending on the choice made. This
  text file is formatted as a Matrix Market file, and as such it is accompanied by
  separate files for the gene identifiers and the samples/runs/cells identifiers.

:Genes (tsv):
  Identifiers (column repeated) for the genes present in the matrix of expression,
  in the same order as the matrix rows.

:Barcodes (tsv):
  Identifiers for the cells, samples or runs of the data matrix. The file is ordered
  to match the columns of the matrix.

:Experiment Design file (tsv):
  Contains metadata for the different cells/samples/runs of the experiment.
  Please note that this file is generated before the filtering step, and while not
  often, it might be the case that it contains more cells/samples/runs than the matrix.

]]></help>
  <citations>
    <citation type="doi">10.1093/nar/gkv1045</citation>
  </citations>
</tool>
