<tool id="ct_downsample_cells" name="Cell types - Downsample Cells" version="@TOOL_VERSION@+galaxy0" profile="@PROFILE@">
    <description>Down-sample cells to avoid memory issues</description>
    <macros>
        <import>ct_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        mkdir expression_data &&
        ln -s '${matrix}' expression_data/matrix.mtx &&
        ln -s '${genes}' expression_data/genes.tsv &&
        ln -s '${barcodes}' expression_data/barcodes.tsv &&
        
        downsample_cells.R --expression-data expression_data --metadata "${metadata}" --cell-id-field "${cell_id_field}" --cell-type-field "${cell_type_field}" --array-size-limit "${array_size_limit}" --output-dir "${output_dir}" --metadata-upd "${metadata_upd}"

        #if $exclusions
        --exclusions "${exclusions}"
        #end if

         ]]></command>
    <inputs>
        <param name="matrix" type="data" format="txt" label="Expression matrix in sparse matrix format (.mtx)"/>
        <param name="genes" type="data" format="tsv,tabular" label="Gene table"/>
        <param name="barcodes" type="data" format="tsv,tabular" label="Barcode/cell table"/>
        <param type="data" name="metadata" format="txt" label="Metadata Table" help="Metadata file mapping cells to cell types" />
        <param type="text" name="cell_id_field" label="Cell ID Field" optional="true" value="id" help="Cell ID field" />
        <param type="text" name="cell_type_field" label="Cell Type Field" optional="true" value="inferred.cell.type" help="Name of cell type column in metada file" />
        <param type="integer" name="array_size_limit" value='2000000000' label="Array Size Limit" help="Maximum length of R array" />
    </inputs>
    
    <outputs>
        <collection name="output_dir" type="list" />
        <data name="metadata_upd" format="txt" />
    </outputs>

    <help><![CDATA[
    @HELP@
    
    @VERSION_HISTORY@
    ]]></help>
    <expand macro="citations" />
</tool>