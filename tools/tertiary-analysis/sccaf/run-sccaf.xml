<?xml version="1.0" encoding="utf-8"?>
<tool id="run-sccaf" name="Run SCCAF" version="@TOOL_VERSION@+galaxy0">
  <description>to assess and optimise clustering</description>
  <macros>
    <import>sccaf_macros.xml</import>
  </macros>
  <expand macro="requirements"/>
  <command detect_errors="exit_code"><![CDATA[
ln -s ${input_obj_file} input.h5 &&
sccaf -i input.h5

#if $cluster_source.use_tsv
  --external-clustering-tsv ${cluster_source.input_tsv}
#else
  --slot-for-existing-clustering ${cluster_source.obj_attr}
#end if

#if $mode.skip_init_assessment
  --skip-assessment
#end if

#if $mode.optimise
  #if not $mode.init.from_input
  --resolution ${mode.init.resolution}
  #end if
  --optimise
  --accuracy ${mode.accuracy}
  --produce-rounds-summary
#end if


]]></command>

  <inputs>
    <expand macro="input_object_params"/>

    <conditional name="cluster_source">
      <param name="use_tsv" type="boolean" checked="true" label="Use external cluster information" help="If the provided AnnData/Loom file does not include the clustering, or if you want to use an external clustering assigment."/>
      <when value="true">
        <param name="input_tsv" type="data" argument="--external-clustering-tsv" format="tsv" label="Cluster table for assessment in tsv format"/>
      </when>
      <when value="false">
        <param name="obj_attr" type="text" argument="--slot-for-existing-clustering" value="louvain" label="Attribute in input object that contains cluster information" help="If you are not using an external clustering, then you must specify the slot/index in the AnnData or Loom file where the clustering to be used for assessment (and potentially optimisation starting point) is saved."/>
      </when>
    </conditional>

    <conditional name="mode">
      <param name="optimise" type="boolean" checked="false" argument="--optimise" label="Run clustering optimisation" help="By default the tool only runs an assesment of the clustering quality. To further optimise the clustering, enable this option."/>
      <when value="true">
        <conditional name="init">
          <param name="from_input" type="boolean" checked="true" label="Use input clustering to initialise optimisation" help="This option uses the previously specified clustering (either external file provided or internal index/slot specified) to serve as starting point for the optimisation process."/>
          <when value="true">
          </when>
          <when value="false">
            <param name="resolution" type="float" value="1.5" argument="--resolution" label="Resolution for initialising louvain clustering" help="Perform an initial clustering and use this as an starting point."/>
          </when>
        </conditional>
        <param name="accuracy" type="float" value="0.90" argument="--accuracy" label="Accuracy for convergence of the optimisation process" help="The SCCAF optimisation process will converge once this accuracy is achieved."/>
        <param name="skip_init_assessment" type="boolean" argument="--skip-assessment" checked="false" label="Run only the optimisation and skip the initial assessment" help="If you are running the optimisation, you can choose skip the initial assessment to save time."/>
      </when>
      <when value="false">
      </when>
    </conditional>
  </inputs>

  <outputs>
    <data name="output_png" format="png" from_work_dir="roc-curve.png" label="${tool.name} on ${on_string} self-projection.png"/>
      <filter>not mode['skip_init_assessment']</filter>
    <data name="output_h5" format="h5" from_work_dir="output.h5" label="${tool.name} on ${on_string} output.h5">
      <filter>mode['optimise']</filter>
    </data>
    <data name="optim_png" format="png" from_work_dir="optim.png" label="${tool.name} on ${on_string} optim.png">
      <filter>mode['optimise']</filter>
    </data>
    <data name="rouds" format="txt" from_work_dir="rounds.txt" label="${tool.name} on ${on_string} rounds.txt">
      <filter>mode['optimise']</filter>
    </data>
  </outputs>

  <tests>
    <test>
      <param name="input_obj_file" value="find_cluster.h5"/>
      <param name="use_tsv" value="true"/>
      <param name="input_tsv" value="find_cluster.tsv"/>
      <output name="output_png" file="run_sccaf.png" ftype="png"/>
    </test>
  </tests>

  <help><![CDATA[
]]></help>
  <!-- <expand macro="citations"/> -->
</tool>
