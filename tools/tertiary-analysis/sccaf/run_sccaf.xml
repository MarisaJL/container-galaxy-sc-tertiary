<?xml version="1.0" encoding="utf-8"?>
<tool id="run_sccaf" name="Run SCCAF" version="@TOOL_VERSION@+galaxy0">
  <description>to assess and optimise clustering</description>
  <macros>
    <import>sccaf_macros.xml</import>
  </macros>
  <expand macro="requirements"/>
  <command detect_errors="exit_code"><![CDATA[
ln -s ${input_obj_file} input.h5 &&
sccaf -i input.h5

#if $cluster_source.use_tsv
  --external-clustering-tsv ${cluster_source.input_tsv}
#else
  --slot-for-existing-clustering ${cluster_source.obj_attr}
#end if

#if $mode.skip_init_assessment
  --skip-assessment
#end if

#if $mode.optimise
  #if not $mode.init.from_input
  --resolution ${mode.init.resolution}
  #end if
  --optimise
  #if $mode.optimisation_stop.condition == "accuracy_threshold"
    --min-accuracy ${mode.optimisation_stop.accuracy}
  #else
    --min-accuracy 0.955
    --undercluster-boundary ${mode.optimisation_stop.min_resolution_clustering_slot}
  #end if
  --produce-rounds-summary

  --optimisation-plots-output ${opt_pdf_out}
  > ${opt_text_out};
#end if

#if $mode.optimise and $mode.distribute_assesment:
mkdir -p outputs;
for round in \$(cat rounds.txt); do
  echo "Round: "\$round;
  echo \$round > outputs/round_\$round\.txt;
done
#end if



]]></command>

  <inputs>
    <expand macro="input_object_params"/>

    <conditional name="cluster_source">
      <param name="use_tsv" type="boolean" checked="true" label="Use external cluster information" help="If the provided AnnData/Loom file does not include the clustering, or if you want to use an external clustering assigment."/>
      <when value="true">
        <param name="input_tsv" type="data" argument="--external-clustering-tsv" format="tsv" label="Cluster table for assessment in tsv format"/>
      </when>
      <when value="false">
        <param name="obj_attr" type="text" argument="--slot-for-existing-clustering" value="louvain" label="Attribute in input object that contains cluster information" help="If you are not using an external clustering, then you must specify the slot/index in the AnnData or Loom file where the clustering to be used for assessment (and potentially optimisation starting point) is saved."/>
      </when>
    </conditional>

    <conditional name="mode">
      <param name="optimise" type="boolean" checked="false" argument="--optimise" label="Run clustering optimisation" help="By default the tool only runs an assesment of the clustering quality. To further optimise the clustering, enable this option."/>
      <when value="true">
        <conditional name="init">
          <param name="from_input" type="boolean" checked="true" label="Use input clustering to initialise optimisation" help="This option uses the previously specified clustering (either external file provided or internal index/slot specified) to serve as starting point for the optimisation process."/>
          <when value="true">
          </when>
          <when value="false">
            <param name="resolution" type="float" value="1.5" argument="--resolution" label="Resolution for initialising louvain clustering" help="Perform an initial clustering and use this as an starting point."/>
          </when>
        </conditional>
        <conditional name="optimisation_stop">
          <param type="select" name="condition" help="How should the optimisation algorithm be stopped." label="Stop condition">
            <option value="accuracy_threshold" selected="true">Set a threshold for accuracy</option>
            <option value="min_resolution_clustering">Use a slot with a low resolution clustering</option>
          </param>
          <when value="accuracy_threshold">
            <param name="accuracy" type="float" value="0.90" argument="--accuracy" label="Accuracy for convergence of the optimisation process" help="The SCCAF optimisation process will converge once this accuracy is achieved."/>
          </when>
          <when value="min_resolution_clustering">
            <param name="min_resolution_clustering_slot" type="text" argument="--undercluster-boundary" label="Underclustering boundary to use in the optimisation." help="The slot inside the ann data object with the desired underclustering (low resolution) to be used as exit condition."/>
          </when>
        </conditional>
        <param name="skip_init_assessment" type="boolean" argument="--skip-assessment" checked="false" label="Run only the optimisation and skip the initial assessment" help="If you are running the optimisation, you can choose skip the initial assessment to save time."/>
        <param name="distribute_assesment" type="boolean" checked="false" label="Produce parameter walk for asessment distribution" help="Will split rounds in files so that multiple assess processes can be distributed down the line"/>
      </when>
      <when value="false">
      </when>
    </conditional>
  </inputs>

  <outputs>
    <data name="output_png" format="png" from_work_dir="roc-curve.png" label="${tool.name} on ${on_string} ROC Curve for initial assesment">
      <filter>not mode['skip_init_assessment']</filter>
    </data>
    <data name="output_h5" format="h5" from_work_dir="output.h5" label="${tool.name} on ${on_string} output.h5">
      <filter>mode['optimise']</filter>
    </data>
    <data name="optim_png" format="png" from_work_dir="optim.png" label="${tool.name} on ${on_string} ROC Curve for optimisation result">
      <filter>mode['optimise']</filter>
    </data>
    <collection name="rounds_walk" type="list" label="Rounds for assesment distribution">
      <filter>mode['optimise'] and mode['distribute_assesment']</filter>
      <discover_datasets pattern="__name_and_ext__" directory="outputs"/>
    </collection>
    <data name="opt_text_out" format="txt" label="${tool.name} on ${on_string} Optimisation process log">
      <filter>mode['optimise']</filter>
    </data>
    <data name="opt_pdf_out" format="pdf" label="${tool.name} on ${on_string} Optimisation process plots">
      <filter>mode['optimise']</filter>
    </data>
  </outputs>

  <tests>
    <test>
      <param name="input_obj_file" value="find_cluster.h5"/>
      <param name="use_tsv" value="true"/>
      <param name="input_tsv" value="find_cluster.tsv"/>
      <output name="output_png" file="run_sccaf.png" ftype="png"/>
    </test>
  </tests>

  <help><![CDATA[
]]></help>
  <!-- <expand macro="citations"/> -->
</tool>
